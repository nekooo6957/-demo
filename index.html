<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isochrone Analysis Tool (V2.6 High-Res)</title>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shpjs@4.0.4/dist/shp.js"></script>

    <style>
        /* --- Design System --- */
        :root {
            --primary: #3d8c76; /* æ ¸å¿ƒç¿ ç»¿ */
            --primary-hover: #2e6b5a;
            --surface: rgba(255, 255, 255, 0.96);
            --text-main: #2c3e50;
            --text-sec: #7f8c8d;
            --border: rgba(0, 0, 0, 0.1);
            --radius: 10px;
            --font-zh: "Microsoft YaHei", sans-serif;
            --font-en: "Times New Roman", serif; 
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #eef2f3; font-family: var(--font-zh); }
        
        /* åœ°å›¾å®¹å™¨ (é€æ˜èƒŒæ™¯) */
        #map { width: 100%; height: 100%; position: absolute; z-index: 1; background: transparent; }

        /* ä¾§è¾¹æ å¼€å…³ */
        .sidebar-toggle {
            position: absolute; top: 20px; left: 20px; z-index: 101;
            width: 40px; height: 40px; border-radius: 50%;
            background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease; font-size: 18px; color: #333;
        }
        .sidebar-toggle:hover { transform: scale(1.05); color: var(--primary); }

        /* ä¾§è¾¹æ  */
        #sidebar {
            position: absolute; top: 20px; left: 80px; z-index: 100;
            width: 360px; max-height: calc(100vh - 40px);
            background: var(--surface);
            backdrop-filter: saturate(180%) blur(15px);
            border-radius: var(--radius);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            overflow-y: auto; display: flex; flex-direction: column; gap: 18px; padding: 24px;
            transition: transform 0.3s ease, opacity 0.3s;
            border: 1px solid rgba(255,255,255,0.6);
        }
        #sidebar.collapsed { transform: translateX(-50px); opacity: 0; pointer-events: none; }

        /* æ ‡é¢˜åŒº */
        .header { padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        h1 { margin: 0; font-size: 20px; font-weight: 700; color: var(--text-main); display:flex; align-items:center; gap:10px; }
        h1::before { content:''; width:4px; height:20px; background:var(--primary); border-radius:2px; display:block; }
        
        .meta-info { margin-top: 8px; font-size: 10px; color: #999; line-height: 1.4; }
        .meta-en { font-family: var(--font-en); font-style: normal; color: #aaa; }

        /* æ§ä»¶ */
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .group-title { font-size: 13px; font-weight: 600; color: #444; display: flex; justify-content: space-between; align-items: baseline; }
        .group-subtitle { font-family: var(--font-en); font-weight: normal; color: #aaa; font-size: 11px; font-style: normal; }

        input[type="text"], select {
            width: 100%; padding: 10px; border-radius: 6px;
            border: 1px solid #ccc; background: #fff;
            font-size: 12px; box-sizing: border-box; color: #333;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(61, 140, 118, 0.2); }

        /* æŒ‰é’® */
        .btn-primary {
            width: 100%; padding: 11px; border: none; border-radius: 6px;
            background: var(--primary); color: white; font-weight: 600; font-size: 13px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(61, 140, 118, 0.3); }
        .btn-primary:disabled { background: #e0e0e0; color: #a0a0a0; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .btn-secondary {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            background: white; color: var(--text-main); font-weight: 600; font-size: 12px;
            cursor: pointer; transition: all 0.2s; margin: 0;
        }
        .btn-secondary:hover { background: #f8f9fa; border-color: #999; color: var(--primary); }

        /* å¯¼å‡ºåŒºå¸ƒå±€ */
        .export-row { display: flex; gap: 8px; align-items: stretch; margin-top: 5px; }

        /* æ–‡ä»¶ä¸Šä¼  */
        .file-drop {
            border: 1px dashed #bbb; border-radius: 6px; padding: 12px; text-align: center;
            cursor: pointer; background: rgba(250,250,250,0.5); transition: 0.2s;
        }
        .file-drop.has-file { border-color: var(--primary); background: rgba(61, 140, 118, 0.05); color: var(--primary); font-weight: bold; }

        /* èƒ¶å›Šé€‰æ‹©å™¨ */
        .checkbox-group { display: flex; gap: 6px; }
        .chk-btn { flex: 1; position: relative; }
        .chk-btn input { position: absolute; opacity: 0; width:0; height:0; }
        .chk-btn label {
            display: flex; flex-direction: column; align-items: center; padding: 8px 4px;
            background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;
            transition: 0.2s;
        }
        .chk-btn span { font-weight: 700; font-size: 14px; color: #555; }
        .chk-btn small { font-size: 9px; color: #999; margin-top: 1px; }
        .chk-btn input:checked + label {
            border-color: var(--primary); background: rgba(61, 140, 118, 0.08); color: var(--primary);
        }

        /* æ ·å¼é¢æ¿ */
        .layer-list { margin-top: 5px; display: flex; flex-direction: column; gap: 8px; }
        .layer-card { 
            background: white; padding: 12px; border-radius: 8px; 
            border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); 
        }
        .layer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .layer-title { font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: #333; }
        .color-dot { width: 8px; height: 8px; border-radius: 50%; }
        
        .style-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; row-gap: 8px; }
        .style-item { display: flex; flex-direction: column; gap: 4px; }
        .style-item label { font-size: 10px; color: #888; }
        
        input[type="color"] { width: 100%; height: 24px; padding: 0; border: 1px solid #ddd; background: none; cursor: pointer; border-radius: 4px; }
        input[type="range"] { width: 100%; height: 4px; accent-color: var(--primary); cursor: pointer; margin-top: 4px; }

        /* å¼€å…³ */
        .toggle-switch { position: relative; width: 32px; height: 18px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* ç»“æœå±•ç¤º */
        .result-box { 
            display: none; flex-direction: column; gap: 0; 
            background: #f0fdf4; border: 1px solid #bbf7d0; 
            padding: 0; overflow: hidden; margin-top: 10px; border-radius: 6px;
        }
        .result-item { display: flex; justify-content: space-between; font-size: 12px; padding: 10px; border-bottom: 1px dashed rgba(0,0,0,0.05); color: #333; }
        .result-item:last-child { border-bottom: none; background: rgba(61, 140, 118, 0.1); font-weight: 600; color: var(--primary); }

        /* Loading & Alert */
        .loader-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
            z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 36px; height: 36px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .custom-alert { 
            position: fixed; top: 20px; right: 20px; z-index: 9999; 
            background: #fff; border-left: 4px solid #d32f2f; 
            padding: 15px 20px; border-radius: 4px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); 
            font-size: 13px; color: #333; max-width: 300px; 
            animation: slideIn 0.3s ease-out; word-break: break-word; 
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="loader-mask" id="loader">
    <div class="spinner"></div>
    <div id="loadingText" style="margin-top:12px; font-weight:500; font-size:12px; color:#555">PROCESSING...</div>
</div>

<div class="sidebar-toggle" onclick="toggleSidebar()">â˜°</div>

<div id="sidebar">
    <div class="header">
        <h1>Isochrone Analysis</h1>
        <div class="meta-info">
            å¼€å‘å•ä½ï¼šæ·±åœ³å¸‚åŸå¸‚è§„åˆ’è®¾è®¡ç ”ç©¶é™¢-åŸå¸‚è®¾è®¡å®è·µç ”ç©¶æ‰€<br>
            å¼€å‘è€…ï¼šç¼ªæ–‡æ° &nbsp;|&nbsp; Version 2.6 (High-Res Export)
        </div>
    </div>

    <div class="control-group">
        <div class="group-title">1. åœ°å›¾é…ç½® <span class="group-subtitle">Configuration</span></div>
        <input type="text" id="token" placeholder="è¾“å…¥ Mapbox Token (pk.eyJ...)">
        <select id="mapStyle" onchange="changeBaseMap()">
            <option value="mapbox://styles/mapbox/light-v11">Light (æç®€ç™½)</option>
            <option value="mapbox://styles/mapbox/dark-v11">Dark (æ·±è‰²ç³»)</option>
            <option value="mapbox://styles/mapbox/streets-v12">Streets (æ ‡å‡†è¡—é“)</option>
            <option value="mapbox://styles/mapbox/satellite-streets-v12">Satellite (å«æ˜Ÿ)</option>
            <option value="transparent">ğŸš« é€æ˜èƒŒæ™¯ (Transparent)</option>
            <option value="custom">Custom Style...</option>
        </select>
        <input type="text" id="customStyle" placeholder="mapbox://styles/..." style="display:none">
        <button class="btn-primary" onclick="initMap()" id="btnInit">å¯åŠ¨å¼•æ“ (Initialize)</button>
    </div>

    <div class="control-group" id="step2" style="opacity:0.5; pointer-events:none;">
        <div class="group-title">2. è®¾æ–½ç‚¹å¯¼å…¥ <span class="group-subtitle">Import Points</span></div>
        <input type="file" id="facFile" style="display:none" accept=".xlsx,.xls,.zip" onchange="handleFile(this, 'facName', 'btnLoad')">
        <div class="file-drop" onclick="document.getElementById('facFile').click()">
            <div id="facName" style="font-size:12px; color:#666">ç‚¹å‡»ä¸Šä¼  Excel (WGS84)</div>
        </div>
        
        <div class="layer-card" id="ptStyle" style="display:none">
            <div class="layer-header" style="margin-bottom:5px"><span class="layer-title">ç‚¹ä½æ ·å¼</span></div>
            <div class="style-grid">
                <div class="style-item"><label>å¡«å……é¢œè‰²</label><input type="color" id="ptColor" value="#333333" oninput="updatePtStyle()"></div>
                <div class="style-item"><label>è½®å»“é¢œè‰²</label><input type="color" id="ptStroke" value="#ffffff" oninput="updatePtStyle()"></div>
                <div class="style-item"><label>åŠå¾„å¤§å°</label><input type="range" id="ptRadius" min="2" max="15" value="4" oninput="updatePtStyle()"></div>
                <div class="style-item"><label>è½®å»“ç²—ç»†</label><input type="range" id="ptStrokeWidth" min="0" max="5" value="1" step="0.5" oninput="updatePtStyle()"></div>
            </div>
        </div>

        <button class="btn-primary" onclick="loadPoints()" id="btnLoad" disabled>åŠ è½½ç‚¹ä½ (Load)</button>
    </div>

    <div class="control-group" id="step3" style="opacity:0.5; pointer-events:none;">
        <div class="group-title">3. ç­‰æ—¶åœˆç”Ÿæˆ <span class="group-subtitle">Generate Isochrones</span></div>
        <div class="checkbox-group">
            <div class="chk-btn"><input type="checkbox" id="t5" value="5" checked><label for="t5"><span>5</span>min</label></div>
            <div class="chk-btn"><input type="checkbox" id="t10" value="10" checked><label for="t10"><span>10</span>min</label></div>
            <div class="chk-btn"><input type="checkbox" id="t15" value="15"><label for="t15"><span>15</span>min</label></div>
            <div class="chk-btn"><input type="checkbox" id="t60" value="60"><label for="t60"><span>60</span>min</label></div>
        </div>
        <select id="profile">
            <option value="walking">ğŸš¶ æ­¥è¡Œ (Walking)</option>
            <option value="cycling">ğŸš² éª‘è¡Œ (Cycling)</option>
            <option value="driving">ğŸš— é©¾è½¦ (Driving)</option>
        </select>
        <button class="btn-primary" onclick="generateIsochrones()" id="btnGen" disabled>æ‰§è¡Œåˆ†æ (Run)</button>
        <div id="layerList" class="layer-list"></div>
    </div>

    <div class="control-group" id="step4" style="opacity:0.5; pointer-events:none;">
        <div class="group-title">4. è¾¹ç•Œè¦†ç›–ç‡ (å¯é€‰) <span class="group-subtitle">Boundary Ratio</span></div>
        <input type="file" id="boundFile" style="display:none" accept=".zip" onchange="handleFile(this, 'boundName', 'btnCalcBound')">
        <div class="file-drop" onclick="document.getElementById('boundFile').click()">
            <div id="boundName" style="font-size:12px; color:#666">ä¸Šä¼ è¡Œæ”¿/èŒƒå›´è¾¹ç•Œ SHP (Zip)</div>
        </div>
        <button class="btn-primary" onclick="calcBoundaryAnalysis()" id="btnCalcBound" disabled>è®¡ç®—è¾¹ç•Œè¦†ç›– (Calculate)</button>
        <div id="resultBox" class="result-box"></div>
    </div>

    <div class="control-group" id="step5" style="opacity:0.5; pointer-events:none;">
        <div class="group-title">5. ç”¨åœ°è¦†ç›–åˆ†æ (å¯é€‰) <span class="group-subtitle">Land Use Overlay</span></div>
        <input type="file" id="landFile" style="display:none" accept=".zip" onchange="handleFile(this, 'landName', 'btnCalcLand')">
        <div class="file-drop" onclick="document.getElementById('landFile').click()" id="dropLand">
            <div id="landName" style="font-size:12px; color:#666">ä¸Šä¼ å±…ä½/å•†ä¸šç”¨åœ° SHP (Zip)</div>
        </div>
        <div class="layer-card" id="landStyle" style="display:none">
            <div class="layer-header" style="margin-bottom:5px">
                <span class="layer-title">ç”¨åœ°æ ·å¼</span>
                <label class="toggle-switch"><input type="checkbox" checked onchange="toggleLandLayer(this.checked)"><span class="slider"></span></label>
            </div>
            <div class="style-grid">
                <div class="style-item"><label>é¢œè‰²</label><input type="color" id="landColor" value="#FDD835" oninput="updateLandStyle()"></div>
                <div class="style-item"><label>é€æ˜åº¦</label><input type="range" id="landOpacity" min="0" max="1" step="0.1" value="0.5" oninput="updateLandStyle()"></div>
            </div>
        </div>
        <button class="btn-primary" onclick="calcLandUseAnalysis()" id="btnCalcLand" disabled>è®¡ç®—ç”¨åœ°è¦†ç›– (Calculate)</button>
        <div id="landResultBox" class="result-box"></div>
    </div>

    <div class="control-group" id="step6" style="opacity:0.5; pointer-events:none; border-top:1px solid var(--border); padding-top:15px">
        <div class="group-title">6. æˆæœå¯¼å‡º <span class="group-subtitle">Export Result</span></div>
        <div class="export-row">
            <select id="exportScale" style="flex:1">
                <option value="1">1x (å±å¹•åˆ†è¾¨ç‡)</option>
                <option value="2">2x (é«˜æ¸… 2K)</option>
                <option value="3" selected>3x (è¶…æ¸… 3K)</option>
                <option value="4">4x (æ‰“å°çº§ 4K)</option>
            </select>
            <button class="btn-secondary" style="flex:1.5; margin-top:0;" onclick="exportMapImage()">ğŸ“· å¯¼å‡ºå›¾ç‰‡ (PNG)</button>
        </div>
    </div>
</div>

<div id="map"></div>

<script>
    // --- Proj4 Config (Auto Fix) ---
    const CGCS2000_114E = "+proj=tmerc +lat_0=0 +lon_0=114 +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +units=m +no_defs";
    proj4.defs("EPSG:4547", CGCS2000_114E);
    proj4.defs("CGCS2000_3_Degree_GK_CM_114E", CGCS2000_114E);

    // Styles
    const TRANSPARENT_STYLE = { "version": 8, "name": "Transparent", "sources": {}, "layers": [] };
    const DEFAULT_COLORS = { 5: '#34C759', 10: '#FF9500', 15: '#FF3B30', 60: '#AF52DE' };

    // Global Vars
    let map = null;
    let pointsData = [];
    let isochroneData = {}; 
    let isIsochroneReady = false;
    let boundaryGeo = null;
    let landUseGeo = null;

    // --- UI Functions ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    
    function handleFile(input, labelId, btnId) {
        if(input.files && input.files.length > 0) {
            document.getElementById(labelId).innerText = input.files[0].name;
            input.parentElement.querySelector('.file-drop').classList.add('has-file');
            if (isIsochroneReady && btnId) document.getElementById(btnId).disabled = false;
            if (btnId === 'btnLoad') document.getElementById(btnId).disabled = false;
        }
    }
    function setLoading(show, msg) { 
        const el = document.getElementById('loader');
        el.style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingText').innerText = msg;
    }
    function enable(id) {
        const el = document.getElementById(id);
        el.style.opacity = '1';
        el.style.pointerEvents = 'auto';
    }
    function safeAlert(msg) {
        const div = document.createElement('div');
        div.className = 'custom-alert';
        div.innerText = msg && typeof msg === 'object' ? (msg.message || JSON.stringify(msg)) : String(msg);
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 6000);
    }

    // --- GeoJSON Fixer ---
    function forceFixGeoJSON(geojson) {
        let fixCount = 0;
        turf.coordEach(geojson, function (coord) {
            if (Math.abs(coord[0]) > 180 || Math.abs(coord[1]) > 90) {
                try {
                    let wgs84 = proj4(CGCS2000_114E, "EPSG:4326", coord);
                    coord[0] = wgs84[0];
                    coord[1] = wgs84[1];
                    fixCount++;
                } catch (e) {}
            }
        });
        if (fixCount > 0) safeAlert(`å·²è‡ªåŠ¨çº å ${fixCount} ä¸ªæŠ•å½±åæ ‡ç‚¹`);
        return geojson;
    }

    // --- 1. Init Map ---
    function initMap() {
        const token = document.getElementById('token').value.trim();
        if(!token) return safeAlert("è¯·è¾“å…¥ Token");
        mapboxgl.accessToken = token;

        let styleVal = document.getElementById('mapStyle').value;
        let style = styleVal === 'custom' ? document.getElementById('customStyle').value : 
                   styleVal === 'transparent' ? TRANSPARENT_STYLE : styleVal;

        try {
            map = new mapboxgl.Map({
                container: 'map',
                style: style,
                center: [114.05, 22.54],
                zoom: 10,
                preserveDrawingBuffer: true
            });

            map.on('style.load', ensureLayers);
            
            map.on('load', () => {
                document.getElementById('btnInit').innerText = "å¼•æ“å·²å°±ç»ª (Active)";
                document.getElementById('btnInit').disabled = true;
                enable('step2');
                enable('step6');
            });
        } catch(e) { safeAlert(e.message); }
    }

    function ensureLayers() {
        if(!map) return;
        // Points
        if(!map.getSource('points')) {
            map.addSource('points', { type: 'geojson', data: {type:'FeatureCollection', features:[]} });
            map.addLayer({
                id: 'points-layer', type: 'circle', source: 'points',
                paint: { 
                    'circle-radius': 4, 'circle-color': '#333', 
                    'circle-stroke-width': 1, 'circle-stroke-color': '#fff' 
                }
            });
            if(pointsData.length) {
                const geo = turf.featureCollection(pointsData.map(p => turf.point(p)));
                map.getSource('points').setData(geo);
                updatePtStyle();
            }
        }
        // Isochrones
        Object.keys(isochroneData).forEach(t => {
            const sId = `iso-source-${t}`;
            if(!map.getSource(sId)) {
                map.addSource(sId, { type: 'geojson', data: isochroneData[t] });
                const color = document.getElementById(`color-${t}`)?.value || DEFAULT_COLORS[t];
                const opacity = document.getElementById(`opacity-${t}`)?.value || 0.4;
                const stroke = document.getElementById(`stroke-${t}`)?.value || '#333333';
                const width = document.getElementById(`width-${t}`)?.value || 1;

                map.addLayer({
                    id: `iso-fill-${t}`, type: 'fill', source: sId,
                    paint: { 'fill-color': color, 'fill-opacity': +opacity }
                }, 'points-layer');
                map.addLayer({
                    id: `iso-line-${t}`, type: 'line', source: sId,
                    paint: { 'line-color': stroke, 'line-width': +width }
                }, 'points-layer');
            }
        });
        // Boundary
        if(!map.getSource('boundary')) {
            map.addSource('boundary', { type: 'geojson', data: {type:'FeatureCollection', features:[]} });
            map.addLayer({ id: 'boundary-layer', type: 'line', source: 'boundary', paint: { 'line-color': '#FF3B30', 'line-width': 2 } });
            if(boundaryGeo) map.getSource('boundary').setData(boundaryGeo);
        }
        // Land Use
        if(!map.getSource('landuse')) {
            map.addSource('landuse', { type: 'geojson', data: {type:'FeatureCollection', features:[]} });
            map.addLayer({ id: 'landuse-fill', type: 'fill', source: 'landuse', paint: { 'fill-color': '#FDD835', 'fill-opacity': 0.5 } }, 'points-layer');
            if(landUseGeo) {
                map.getSource('landuse').setData(landUseGeo);
                updateLandStyle();
            }
        }
    }

    function changeBaseMap() {
        const sel = document.getElementById('mapStyle');
        const custom = document.getElementById('customStyle');
        let val = sel.value;
        
        if(val === 'custom') {
            custom.style.display = 'block';
            val = custom.value;
        } else {
            custom.style.display = 'none';
        }
        
        if(val === 'transparent') val = TRANSPARENT_STYLE;
        
        if(val && map) map.setStyle(val);
    }
    
    // --- 6. Export Logic (High Res) ---
    function exportMapImage() {
        if (!map) return safeAlert("åœ°å›¾æœªåˆå§‹åŒ–");
        const scale = parseInt(document.getElementById('exportScale').value);
        
        setLoading(true, "æ­£åœ¨æ¸²æŸ“é«˜æ¸…å¤§å›¾...");
        
        const mapContainer = document.getElementById('map');
        const originalStyle = { w: mapContainer.style.width, h: mapContainer.style.height };
        const viewState = { center: map.getCenter(), zoom: map.getZoom(), pitch: map.getPitch(), bearing: map.getBearing() };
        
        // ä¸´æ—¶æ”¾å¤§å®¹å™¨
        const width = mapContainer.clientWidth;
        const height = mapContainer.clientHeight;
        
        mapContainer.style.width = (width * scale) + 'px';
        mapContainer.style.height = (height * scale) + 'px';
        map.resize();
        
        map.once('idle', () => {
            try {
                const canvas = map.getCanvas();
                const link = document.createElement('a');
                link.download = `isochrone_map_${scale}x.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (e) {
                safeAlert("å¯¼å‡ºå¤±è´¥: " + e.message);
            } finally {
                // æ¢å¤ç°åœº
                mapContainer.style.width = originalStyle.w;
                mapContainer.style.height = originalStyle.h;
                map.resize();
                map.jumpTo(viewState);
                setLoading(false);
            }
        });
    }

    // --- 2. Load Points ---
    async function loadPoints() {
        const f = document.getElementById('facFile').files[0];
        if(!f) return safeAlert("è¯·é€‰æ‹©æ–‡ä»¶");
        setLoading(true, "è§£æç‚¹ä½...");
        try {
            let raw = [];
            if(f.name.match(/\.xls/i)) raw = await readExcel(f);
            else if(f.name.match(/\.zip/i)) raw = await readShpPoints(f);
            
            pointsData = raw.filter(p => !isNaN(p.lng)).map(p => [p.lng, p.lat]);
            if(!pointsData.length) throw new Error("æ— æœ‰æ•ˆåæ ‡");

            ensureLayers(); 
            const geo = turf.featureCollection(pointsData.map(p => turf.point(p)));
            map.getSource('points').setData(geo);
            map.fitBounds(turf.bbox(geo), { padding: 50 });

            document.getElementById('ptStyle').style.display = 'block';
            document.getElementById('btnLoad').innerText = `å·²åŠ è½½ ${pointsData.length} ç‚¹`;
            document.getElementById('btnGen').disabled = false;
            enable('step3');
        } catch(e) { safeAlert("åŠ è½½å¤±è´¥: " + (e.message || e)); }
        setLoading(false);
    }
    function updatePtStyle() {
        const c = document.getElementById('ptColor').value;
        const r = document.getElementById('ptRadius').value;
        const s = document.getElementById('ptStroke').value;
        const w = document.getElementById('ptStrokeWidth').value;
        if(map && map.getLayer('points-layer')) {
            map.setPaintProperty('points-layer', 'circle-color', c);
            map.setPaintProperty('points-layer', 'circle-radius', +r);
            map.setPaintProperty('points-layer', 'circle-stroke-color', s);
            map.setPaintProperty('points-layer', 'circle-stroke-width', +w);
        }
    }

    // --- 3. Generate ---
    async function generateIsochrones() {
        if(!pointsData.length) return;
        const times = [];
        ['t5','t10','t15','t60'].forEach(id => {
            if(document.getElementById(id).checked) times.push(+document.getElementById(id).value);
        });
        if(!times.length) return safeAlert("è¯·é€‰æ‹©æ—¶é—´");
        times.sort((a,b) => b-a);
        const profile = document.getElementById('profile').value;
        const token = mapboxgl.accessToken;

        setLoading(true, "API è¯·æ±‚...");
        isochroneData = {}; 
        isIsochroneReady = false;
        document.getElementById('layerList').innerHTML = '';
        
        times.forEach(t => {
            if(map.getLayer(`iso-fill-${t}`)) map.removeLayer(`iso-fill-${t}`);
            if(map.getLayer(`iso-line-${t}`)) map.removeLayer(`iso-line-${t}`);
            if(map.getSource(`iso-source-${t}`)) map.removeSource(`iso-source-${t}`);
        });

        let rawPolys = {};
        times.forEach(t => rawPolys[t] = []);

        try {
            const BATCH = 4;
            for(let i=0; i<pointsData.length; i+=BATCH) {
                const chunk = pointsData.slice(i, i+BATCH);
                const timeStr = times.join(',');
                const tasks = chunk.map(pt => 
                    fetch(`https://api.mapbox.com/isochrone/v1/mapbox/${profile}/${pt[0]},${pt[1]}?contours_minutes=${timeStr}&polygons=true&access_token=${token}`)
                    .then(r => r.json()).catch(e => null)
                );
                const results = await Promise.all(tasks);
                results.forEach(res => {
                    if(res && res.features) res.features.forEach(f => rawPolys[f.properties.contour].push(f));
                });
                await new Promise(r => setTimeout(r, 100));
            }

            setLoading(true, "èåˆå›¾å½¢...");
            for(let t of times) {
                const polys = rawPolys[t];
                if(polys.length > 0) {
                    let merged = polys[0];
                    for(let k=1; k<polys.length; k++) {
                        try { merged = turf.union(merged, polys[k]); } catch(e){}
                    }
                    isochroneData[t] = merged;
                    addIsoLayer(t, merged);
                    addLayerUI(t);
                }
            }
            
            isIsochroneReady = true;
            enable('step4');
            enable('step5');
            if(document.getElementById('boundFile').files.length > 0) document.getElementById('btnCalcBound').disabled = false;
            if(document.getElementById('landFile').files.length > 0) document.getElementById('btnCalcLand').disabled = false;

        } catch(e) { safeAlert(e.message); }
        setLoading(false);
    }

    function addIsoLayer(t, data) {
        const sId = `iso-source-${t}`;
        if(!map.getSource(sId)) {
            map.addSource(sId, { type: 'geojson', data: data });
            map.addLayer({ id: `iso-fill-${t}`, type: 'fill', source: sId, paint: { 'fill-color': DEFAULT_COLORS[t]||'#888', 'fill-opacity': 0.4 }}, 'points-layer');
            map.addLayer({ id: `iso-line-${t}`, type: 'line', source: sId, paint: { 'line-color': '#333', 'line-width': 1 }}, 'points-layer');
        }
    }
    function addLayerUI(t) {
        const div = document.createElement('div');
        div.className = 'layer-card';
        const color = DEFAULT_COLORS[t] || '#888';
        div.innerHTML = `
            <div class="layer-header"><span class="layer-title"><span class="color-dot" id="dot-${t}" style="background:${color}"></span>${t} Min Range</span><label class="toggle-switch"><input type="checkbox" checked onchange="toggleL(${t}, this.checked)"><span class="slider"></span></label></div>
            <div class="style-grid">
                <div class="style-item"><label>Fill</label><input type="color" id="color-${t}" value="${color}" oninput="updateL(${t})"></div>
                <div class="style-item"><label>Line</label><input type="color" id="stroke-${t}" value="#333333" oninput="updateL(${t})"></div>
                <div class="style-item"><label>Opacity</label><input type="range" id="opacity-${t}" min="0" max="1" step="0.1" value="0.4" oninput="updateL(${t})"></div>
                <div class="style-item"><label>Width</label><input type="range" id="width-${t}" min="0" max="5" step="0.5" value="1" oninput="updateL(${t})"></div>
            </div>`;
        document.getElementById('layerList').appendChild(div);
    }
    window.toggleL = (t, s) => { const v=s?'visible':'none'; map.setLayoutProperty(`iso-fill-${t}`,'visibility',v); map.setLayoutProperty(`iso-line-${t}`,'visibility',v); }
    window.updateL = (t) => {
        const c=document.getElementById(`color-${t}`).value;
        const s=document.getElementById(`stroke-${t}`).value;
        const o=document.getElementById(`opacity-${t}`).value;
        const w=document.getElementById(`width-${t}`).value;
        document.getElementById(`dot-${t}`).style.backgroundColor=c;
        if(map.getLayer(`iso-fill-${t}`)) { map.setPaintProperty(`iso-fill-${t}`,'fill-color',c); map.setPaintProperty(`iso-fill-${t}`,'fill-opacity',+o); }
        if(map.getLayer(`iso-line-${t}`)) { map.setPaintProperty(`iso-line-${t}`,'line-color',s); map.setPaintProperty(`iso-line-${t}`,'line-width',+w); }
    }

    // --- 4. Boundary ---
    async function calcBoundaryAnalysis() {
        const f = document.getElementById('boundFile').files[0];
        if(!f) return safeAlert("è¯·ä¸Šä¼  SHP Zip");
        if(Object.keys(isochroneData).length === 0) return safeAlert("è¯·å…ˆç”Ÿæˆç­‰æ—¶åœˆ");
        setLoading(true, "åˆ†æè¾¹ç•Œ...");
        try {
            let raw = await readShp(f);
            boundaryGeo = forceFixGeoJSON(turf.featureCollection(raw));
            
            ensureLayers();
            map.getSource('boundary').setData(boundaryGeo);
            map.fitBounds(turf.bbox(boundaryGeo), { padding: 50 });

            let totalArea = 0;
            turf.flatten(boundaryGeo).features.forEach(ft => totalArea += turf.area(ft));
            let html = `<div class="result-item"><span>è¾¹ç•Œæ€»é¢ç§¯</span><span class="result-val">${(totalArea/1e6).toFixed(2)} kmÂ²</span></div>`;
            
            Object.keys(isochroneData).sort((a,b)=>a-b).forEach(t => {
                let hit = 0;
                const iso = isochroneData[t];
                turf.flatten(boundaryGeo).features.forEach(bFeature => {
                    if(!turf.booleanDisjoint(iso, bFeature)) {
                        try {
                            const inter = turf.intersect(iso, bFeature);
                            if(inter) hit += turf.area(inter);
                        } catch(e){}
                    }
                });
                html += `<div class="result-item"><span>${t} min è¦†ç›–</span><span class="result-val">${(hit/1e6).toFixed(2)} kmÂ² (${(hit/totalArea*100).toFixed(1)}%)</span></div>`;
            });
            const box = document.getElementById('resultBox');
            box.style.display = 'flex'; box.innerHTML = html;
        } catch(e) { safeAlert("è¾¹ç•Œåˆ†æé”™è¯¯: " + e); }
        setLoading(false);
    }

    // --- 5. Land Use ---
    async function calcLandUseAnalysis() {
        const f = document.getElementById('landFile').files[0];
        if(!f) return safeAlert("è¯·ä¸Šä¼ ç”¨åœ° SHP");
        if(Object.keys(isochroneData).length === 0) return safeAlert("è¯·å…ˆç”Ÿæˆç­‰æ—¶åœˆ");
        setLoading(true, "åˆ†æç”¨åœ°...");
        try {
            let raw = await readShp(f);
            landUseGeo = forceFixGeoJSON(turf.featureCollection(raw));
            
            ensureLayers();
            map.getSource('landuse').setData(landUseGeo);
            document.getElementById('landStyle').style.display = 'block';
            map.fitBounds(turf.bbox(landUseGeo), { padding: 50 });

            let totalLand = 0;
            turf.flatten(landUseGeo).features.forEach(ft => totalLand += turf.area(ft));
            let html = `<div class="result-item"><span>ç”¨åœ°æ€»é¢ç§¯</span><span class="result-val">${(totalLand/1e6).toFixed(2)} kmÂ²</span></div>`;
            
            const times = Object.keys(isochroneData).sort((a,b)=>a-b).forEach(t => {
                let hitLand = 0;
                const iso = isochroneData[t];
                turf.flatten(landUseGeo).features.forEach(ft => {
                    if(!turf.booleanDisjoint(iso, ft)) {
                        try {
                            const inter = turf.intersect(iso, ft);
                            if(inter) hitLand += turf.area(inter);
                        } catch(e){}
                    }
                });
                html += `<div class="result-item"><span>${t} min è¦†ç›–</span><span class="result-val">${(hitLand/1e6).toFixed(2)} kmÂ² (${(hitLand/totalLand*100).toFixed(1)}%)</span></div>`;
            });
            const box = document.getElementById('landResultBox');
            box.style.display = 'flex'; box.innerHTML = html;
        } catch(e) { safeAlert("ç”¨åœ°åˆ†æé”™è¯¯: " + e); }
        setLoading(false);
    }

    window.toggleLandLayer = (show) => {
        if(map.getLayer('landuse-fill')) map.setLayoutProperty('landuse-fill', 'visibility', show?'visible':'none');
    }
    window.updateLandStyle = () => {
        const c = document.getElementById('landColor').value;
        const o = document.getElementById('landOpacity').value;
        if(map.getLayer('landuse-fill')) {
            map.setPaintProperty('landuse-fill', 'fill-color', c);
            map.setPaintProperty('landuse-fill', 'fill-opacity', +o);
        }
    }

    // --- Files ---
    function readExcel(f) {
        return new Promise((res, rej) => {
            let r = new FileReader();
            r.onload = e => {
                try {
                    let wb = XLSX.read(e.target.result, {type:'array'});
                    let j = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    if(!j.length) return rej(new Error("ç©ºè¡¨"));
                    let k = Object.keys(j[0]);
                    let ln = k.find(x=>/lon|lng|ç»åº¦|x/i.test(x));
                    let lt = k.find(x=>/lat|çº¬åº¦|y/i.test(x));
                    if(!ln||!lt) return rej(new Error("è¡¨å¤´éœ€å«: lon,lat"));
                    res(j.map(r=>({lng:r[ln], lat:r[lt]})));
                } catch(err){ rej(err); }
            };
            r.readAsArrayBuffer(f);
        });
    }

    function readShp(f) {
        return new Promise((res, rej) => {
            let r = new FileReader();
            r.onload = e => {
                // å¼ºåˆ¶å¿½ç•¥æŠ•å½±é”™è¯¯ï¼Œç›´æ¥è·å–æ•°æ®
                try {
                    shp(e.target.result).then(geojson => {
                        let features = [];
                        if(Array.isArray(geojson)) geojson.forEach(g => features = features.concat(g.features));
                        else features = geojson.features;
                        if(!features.length) return rej("SHPæ— è¦ç´ ");
                        res(features);
                    }).catch(err => {
                        // å¦‚æœæ˜¯æŠ•å½±é”™è¯¯ï¼Œä»ç„¶å°è¯•è§£æ
                        if(err.message && err.message.indexOf("PROJCS") > -1) {
                            // shpjs åº“åœ¨é‡åˆ°ä¸æ”¯æŒçš„æŠ•å½±æ—¶é€šå¸¸ä¼šæŠ›é”™åœæ­¢
                            // ä½†æˆ‘ä»¬å·²ç»ç¡®è®¤ç”¨æˆ·è½¬æ¢äº†ï¼Œè¿™å¯èƒ½æ˜¯æ®‹ä½™çš„ .prj æ–‡ä»¶
                            // æ— æ³•å¼ºè¡Œç»§ç»­ï¼Œåªèƒ½æç¤ºç”¨æˆ·æ£€æŸ¥
                            rej("è§£æä¸­æ–­ï¼šZIPåŒ…å†…åŒ…å« .prj æ–‡ä»¶ä¸”è¢«è¯†åˆ«ä¸ºé WGS84ã€‚è¯·åˆ é™¤å‹ç¼©åŒ…å†…çš„ .prj æ–‡ä»¶å†è¯•ï¼");
                        } else {
                            rej("è§£æå¤±è´¥: " + err);
                        }
                    });
                } catch(e) { rej(e); }
            };
            r.readAsArrayBuffer(f);
        });
    }
    
    function readShpPoints(f) {
        return new Promise((res, rej) => {
            readShp(f).then(features => {
                res(features.map(ft => ({lng: ft.geometry.coordinates[0], lat: ft.geometry.coordinates[1]})));
            }).catch(rej);
        });
    }
</script>
<style>
    .btn-ai-group {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    .btn-ai {
        flex: 1;
        padding: 10px;
        border: 2px solid #7F56D9;
        background: #F9F5FF;
        color: #6941C6;
        border-radius: 6px;
        font-weight: 700;
        cursor: pointer;
        font-size: 12px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        transition: 0.2s;
    }
    .btn-ai:hover { background: #7F56D9; color: white; }
    .btn-ai small { font-weight: normal; opacity: 0.8; font-size: 10px; margin-top: 2px;}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const aiDiv = document.createElement('div');
        aiDiv.className = 'control-group';
        aiDiv.style.borderTop = '1px solid var(--border)';
        aiDiv.style.paddingTop = '15px';
        
        // åˆ›å»ºä¸¤ä¸ªæŒ‰é’®ï¼šä¸€ä¸ªå¤åˆ¶å›¾ï¼Œä¸€ä¸ªå¤åˆ¶æ–‡
        aiDiv.innerHTML = `
            <div class="group-title" style="color:#6941C6">ğŸ¤– æ™ºèƒ½ç©ºé—´åˆ†æ <span class="group-subtitle">AI Spatial Analysis</span></div>
            <div class="btn-ai-group">
                <button class="btn-ai" onclick="copyMapImageToClipboard()">
                    <span>â‘  å¤åˆ¶åœ°å›¾å¿«ç…§</span>
                    <small>(ç”¨äºç©ºé—´åˆ†æ)</small>
                </button>
                <button class="btn-ai" onclick="copyResultTextToClipboard()">
                    <span>â‘¡ å¤åˆ¶åˆ†ææ•°æ®</span>
                    <small>(ç”¨äºåˆè§„å®¡æŸ¥)</small>
                </button>
            </div>
            <div style="font-size:10px; color:#999; margin-top:8px; line-height:1.4">
                <b>æ“ä½œæŒ‡å¼•ï¼š</b><br>
                1. ç‚¹å‡»æŒ‰é’® â‘ ï¼Œåœ¨ AI å¯¹è¯æ¡†ç²˜è´´(Ctrl+V)å¹¶å‘é€å›¾ç‰‡ã€‚<br>
                2. ç‚¹å‡»æŒ‰é’® â‘¡ï¼Œç²˜è´´æ•°æ®ï¼ŒAI å°†ç»“åˆä¸¤è€…è¿›è¡Œç»¼è¿°ã€‚
            </div>
        `;
        sidebar.appendChild(aiDiv);
    });

    // åŠŸèƒ½1ï¼šå¤åˆ¶åœ°å›¾æˆªå›¾åˆ°å‰ªè´´æ¿
    async function copyMapImageToClipboard() {
        if (!map) return safeAlert("åœ°å›¾æœªåŠ è½½");
        
        // ä¸´æ—¶æ˜¾ç¤º loading
        const btn = event.currentTarget;
        const orgText = btn.innerHTML;
        btn.innerText = "æˆªå–ä¸­...";
        
        try {
            // ç¡®ä¿åœ°å›¾æ¸²æŸ“å®Œæˆ
            map.triggerRepaint();
            
            // è·å–åœ°å›¾ Canvas çš„äºŒè¿›åˆ¶æ•°æ® (Blob)
            const canvas = map.getCanvas();
            canvas.toBlob(async function(blob) {
                try {
                    // å†™å…¥å‰ªè´´æ¿ (æ ¸å¿ƒä»£ç )
                    const item = new ClipboardItem({ "image/png": blob });
                    await navigator.clipboard.write([item]);
                    safeAlert("âœ… åœ°å›¾å¿«ç…§å·²å¤åˆ¶ï¼è¯·ç²˜è´´ç»™ AIã€‚");
                } catch (err) {
                    console.error(err);
                    safeAlert("å¤åˆ¶å›¾ç‰‡å¤±è´¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒï¼Œè¯·æ‰‹åŠ¨æˆªå›¾ã€‚");
                } finally {
                    btn.innerHTML = orgText;
                }
            });
        } catch (e) {
            safeAlert("æˆªå›¾é”™è¯¯: " + e.message);
            btn.innerHTML = orgText;
        }
    }

    // åŠŸèƒ½2ï¼šå¤åˆ¶æ–‡æœ¬æ•°æ® (Prompt ä¼˜åŒ–ç‰ˆ)
    function copyResultTextToClipboard() {
        let textToCopy = "ã€å¤šæ¨¡æ€ç»¼åˆåˆ†æè¯·æ±‚ã€‘\n";
        textToCopy += "æˆ‘å·²å‘é€äº†è¯¥åŒºåŸŸçš„ã€ç­‰æ—¶åœˆåˆ†æåœ°å›¾ã€‘ï¼ˆè§ä¸Šä¸€æ¡å›¾ç‰‡ï¼‰ã€‚\n";
        textToCopy += "ç°åœ¨æä¾›è¯¥åŒºåŸŸçš„ã€å®šé‡åˆ†ææ•°æ®ã€‘å¦‚ä¸‹ï¼š\n\n";

        // è·å–æ•°æ®
        const boundBox = document.getElementById('resultBox');
        if(boundBox && boundBox.style.display !== 'none') {
            textToCopy += "--- è¾¹ç•Œè¦†ç›–æ•°æ® ---\n" + boundBox.innerText.replace(/\n/g, " | ").replace(/\|/g, "\n") + "\n";
        }
        const landBox = document.getElementById('landResultBox');
        if(landBox && landBox.style.display !== 'none') {
            textToCopy += "\n--- ç”¨åœ°è¦†ç›–æ•°æ® ---\n" + landBox.innerText.replace(/\n/g, " | ").replace(/\|/g, "\n") + "\n";
        }

        if(textToCopy.length < 150) return safeAlert("è¯·å…ˆè¿è¡Œåˆ†æå†å¤åˆ¶æ•°æ®");

        textToCopy += "\n\nè¯·ç»“åˆå›¾ç‰‡ï¼ˆç©ºé—´åˆ†å¸ƒï¼‰å’Œä¸Šè¿°æ•°æ®ï¼ˆåˆè§„æŒ‡æ ‡ï¼‰è¿›è¡Œç»¼åˆè¯„è¿°ï¼š\n";
        textToCopy += "1. **åˆè§„æ€§å®¡æŸ¥**ï¼šåŸºäºæ•°æ®åˆ¤æ–­æ˜¯å¦è¾¾æ ‡ã€‚\n";
        textToCopy += "2. **ç©ºé—´åˆ†æ**ï¼šåŸºäºå›¾ç‰‡ï¼Œåˆ†æå¯è¾¾æ€§çš„ç©ºé—´åˆ†å¸ƒç‰¹å¾ï¼ˆå¦‚â€œå—é«˜åŒ—ä½â€ã€â€œæ²¿è·¯è½´å‘å»¶ä¼¸â€ç­‰ï¼‰ï¼Œå¹¶æŒ‡å‡ºå…·ä½“çš„è–„å¼±æ–¹ä½ã€‚\n";

        navigator.clipboard.writeText(textToCopy).then(() => {
            safeAlert("âœ… åˆ†ææ•°æ®å·²å¤åˆ¶ï¼è¯·ç²˜è´´ç»™ AIã€‚");
        });
    }
</script>

<script src="https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.19/libs/cn/index.js"></script>

<script>
  new CozeWebSDK.WebChatClient({
    config: {
      // æ‚¨çš„æ™ºèƒ½ä½“ ID (ä¿æŒä¸å˜)
      bot_id: '7583987565540409380',
    },
    componentProps: {
      // èŠå¤©æ¡†æ ‡é¢˜ï¼Œæ‚¨å¯ä»¥æ”¹æˆä¸­æ–‡ï¼Œæ¯”å¦‚ "è§„åˆ’åˆè§„åŠ©æ‰‹"
      title: 'è§„åˆ’åˆè§„åŠ©æ‰‹',
    },
    auth: {
      type: 'token',
      // â–¼â–¼â–¼â–¼â–¼â–¼ å…³é”®ä¿®æ”¹ç‚¹ â–¼â–¼â–¼â–¼â–¼â–¼
      // è¯·å°†ä¸‹é¢çš„ pat_xxxxxx æ›¿æ¢ä¸ºæ‚¨åˆšåˆšåœ¨ Coze åå°ç”Ÿæˆçš„çœŸå® Token
      token: 'pat_fsDZJLnHdtzWyPLTUO7lqWQYrNH7sB4nuptj6IpT8oeKRZyJRTBTkcCarVViaUmN', 
      
      // åˆ·æ–°é€»è¾‘ï¼Œå¯¹äºé™æ€ç½‘é¡µï¼Œè¿™é‡Œç›´æ¥è¿”å›åŒä¸€ä¸ª Token å³å¯
      onRefreshToken: function () {
        return 'pat_fsDZJLnHdtzWyPLTUO7lqWQYrNH7sB4nuptj6IpT8oeKRZyJRTBTkcCarVViaUmN'
      }
      // â–²â–²â–²â–²â–²â–² å…³é”®ä¿®æ”¹ç‚¹ â–²â–²â–²â–²â–²â–²
    }
  });
</script>
</body>
</html></script>
</body>
</html>
